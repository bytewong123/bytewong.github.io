---
title: 聚合列表
date: 2023-01-08T18:06:57+08:00
draft: false
categories: ["系统设计"]
tags: ["系统设计"]
---

# 聚合列表
#技术/系统设计


1. 点赞几十万写tps，视频量级为百亿级，视频可能有热点流量，只记录点赞数量 
2. 榜单：全局视频点赞榜，top2000，5s以内延迟，可以无限翻页，2000以外的可以接受更高的延迟

一个比较典型的业务场景是热门视频列表（泛指抖音的各种聚合页场景，eg：话题聚合页，音乐聚合页下的视频列表），他们有以下特点

1. 写多读少:按点赞排序，点一次赞写入一次
2. 数据量大:比如音乐聚合页场景，每创建一个原声视频（使用拍摄器录制声音）都会创建一个 MusicId ，通常这个 MusicId 下面也只有一个 ItemId
3. 写操作幂等 每次写入时都会将最新的点赞数写入


两级存储：
1. 缓存+持久化存储
	1. redis
	缓存分两部分：视频点赞数缓存、全局表单缓存；
	- 视频点赞数缓存，可以让key作为视频id，value作为点赞数
	- 全局榜单缓存，zset数据结构，key为榜单名，member为item id，score为点赞数，存储前2000元素；
	2.  mysql主存储
	- 视频点赞
		- mysql，用视频id作为分区键，分表
		- 读取优先读redis，读不到回源mysql，并将值刷入到缓存中
		- 写入时保证mysql写入成功，再写入redis
		- 可以通过聚合写入的方式，将写入请求通过消息队列削峰，相同视频id发往同一个partition，用类似flink任务进行聚合，聚合一定时间后再写入db；
		- 本地缓存+多级缓存，依次回源
	- 全局榜单
		- 如何持久化存储？
2. 榜单
	1. Top 2000；zset实现，2000以外的回源db；
	2. 单点redis 10w qps，不能满足需求。通过mq来削峰，榜单和点赞都应使用，通过该队列来延迟。flink计算累计点赞量，下游消费更新点赞，减少写qps。队列分区，根据视频id进行分区。



[凉了呀，面试官叫我设计一个排行榜。 - SegmentFault 思否](https://segmentfault.com/a/1190000039320528)