---
title: 计数系统设计
date: 2023-01-08T18:06:57+08:00
draft: false
categories: ["系统设计"]
tags: ["系统设计"]
---

# 计数系统设计
#技术/系统设计

- 存储
为了保证一致性，直接使用redis进行存储
hash数据结构
redis扩容需要迁移数据

- 缓存
使用 Redis 来加速读请求，通过部署多个从节点来提升可用性和性能，并且通过 Hash 的方式对数据做分片，也基本上可以保证计数的读取性能

- 本地缓存
本地缓存miss则从redis获取并回写至本地缓存

- 容灾
同构存储、异构存储

- 消息队列
由于热门微博的计数变化频率相当高，也需要考虑如何提升计数的写入性能。比如，每次在转发一条微博的时候，都需要增加这条微博的转发数，那么如果明星发布结婚、离婚的微博，瞬时就可能会产生几万甚至几十万的转发。如果是你的话，要如何降低写压力呢？
用消息队列来削峰填谷了，也就是说，我们在转发微博的时候向消息队列写入一条消息，然后在消息处理程序中给这条微博的转发计数加 1。这里需要注意的一点， 我们可以通过批量处理消息的方式进一步减小 Redis 的写压力

- 聚合写
本地LRU缓存，记录更新时间，定时检查最老的数据超过某一时间阈值，将其批量写入到db中；
由于可能存在同一个key的写入请求，被打入不同实例中，造成聚合效果不佳，可以再加一个中间层，将key进行hash计算后发往该层进行二次聚合