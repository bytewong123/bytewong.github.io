---
title: 信息流系统设计
date: 2023-01-08T18:06:57+08:00
draft: false
categories: ["系统设计"]
tags: ["系统设计"]
---

# 信息流系统设计
#技术/系统设计

类似微博，用户发布微博后，其粉丝能够收到关注的人发的新微博，并且按时间序排序，如何设计？

1. 关系存储，三张表：
- 关注关系表
- 微博表
- 用户表

首先查询某一用户的所有关注者发布的微博，然后将其按时间序排序

## 推模式
- 给每个用户的时间线维护一份缓存；当用户发微博时，查询其所有的粉丝，然后将该微博的id插入到其粉丝的时间线缓存中；
- 读的量级远大于写的量级，在发布时多完成一些事情可以增加读性能。
- 但是这种方式会有写放大的问题：
	- 如果某一用户有几千万粉丝，那么发布一条消息需要写几千万次。写这一操作要求尽量快，如果需要在5秒以内完成，那么这是一个巨大的挑战。
	- 存储消耗巨大，大V每次发一条微博，都需要将这个微博信息给所有粉丝都存储一次
		- 解决方式：选择压缩率更高的压缩算法/存储引擎；定期地清理用户的收件箱，比如只保留最近 1 个月的数据
	- 大V如果删除微博，需要给他所有的粉丝的收件箱都删除掉该微博
		- 解决方式：读取时判断是否删除
	- 如果你将一个人取消关注，那么需要从你的收件箱中删除这个人的所有微博，假设他发了非常多的微博，那么即使你之后很久不登录，也需要从你的收件箱中做大量的删除操作
		- 解决方式：读取时判断和微博作者是否有关注关系

推模式的适用范围：
比较适合于一个用户的粉丝数比较有限的场景，比如说微信朋友圈，你可以理解为我在微信中增加一个好友是关注了他也被他关注，所以好友的上限也就是粉丝的上限（朋友圈应该是 5000）。
有限的粉丝数可以保证消息能够尽量快地被推送给所有的粉丝，增加的存储成本也比较有限。如果你的业务中粉丝数是有限制的，那么在实现以关注关系为基础的信息流时，也可以采用推模式来实现。

### 总结
1. 推模式就是在用户发送微博时，主动将微博写入到他的粉丝的收件箱中；
2. 推送信息是否延迟、存储的成本、方案的可扩展性以及针对取消关注和微博删除的特殊处理是推模式的主要问题；
3. 推模式比较适合粉丝数有限的场景。

## 拉模式
所谓拉模式，就是指用户主动拉取他关注的所有人的微博，将这些微博按照发布时间的倒序进行排序和聚合之后，生成信息流数据的方法。

用户的收件箱不再有用，因为信息流数据不再出自收件箱，而是出自发件箱。发件箱里是用户关注的所有人数据的聚合。因此**用户在发微博的时候就只需要写入自己的发件箱，而不再需要推送给粉丝的收件箱了**，这样在获取信息流的时候，就要查询发件箱的数据了。

### 优点
1. 拉模式彻底解决了推送延迟的问题，大 V 发微博的时候不再需要推送到粉丝的收件箱，自然就不存在延迟的问题了
2. 存储成本大大降低了。在推模式下，谢娜的粉丝有 1.2 亿，那么谢娜发送一条微博就要被复制 1.2 亿条，写入到存储系统中。在拉模式下只保留了发件箱，微博数据不再需要复制，成本也就随之降低了
3. 功能扩展性更好了。比如，微博增加了分组的功能，而你想把关注的 A 和 B 分成一个单独的组，那么 A 和 B 发布的微博就形成了一个新的信息流，这个信息流要如何实现呢？很简单，你只需要查询这个分组下所有用户（也就是 A 和 B），然后查询这些用户的发件箱，再把发件箱中的数据，按照时间倒序重新排序聚合就好了

### 缺点
1. 拉模式下，我们需要对多个发件箱的数据做聚合，这个查询和聚合的成本比较高。微博的关注上限是 2000，假如你关注了 2000 人，就要查询这 2000 人发布的微博信息，然后再对查询出来的信息做聚合。

解决方式：我们可以把用户发布的微博 ID 放在缓存中。用户很少翻看五天之前的微博内容，所以我们只缓存了每个用户最近 5 天发布的微博 ID。假设我们部署 6 个缓存节点来存储这些微博 ID，在每次聚合时并行从这几个缓存节点中批量查询多个用户的微博 ID，获取到之后再在应用服务内存中排序后就好了，这就是对缓存的 6 次请求，可以保证在 5 毫秒之内返回结果。

2. 缓存节点的带宽成本比较高。每个缓存节点每秒要被查询多次。部署多个缓存副本提升缓存可用性，其实，缓存副本也可以分摊带宽的压力。我们知道在部署缓存副本之后，请求会先查询副本中的数据，只有不命中的请求才会查询主缓存的数据

## 推拉结合
在系统搭建初期已经基于推模式实现了一套信息流系统，如果把它推倒重新使用拉模式实现的话，系统的改造成本未免太高了。有没有一种基于推模式的折中的方案呢？
方案的核心在于大 V 用户在发布微博的时候，不再推送到全量用户，而是只推送给活跃的用户。

如何判断大V用户
1. 以粉丝数作为判断标准，比如，粉丝数超过 50 万就算作大 V，需要只推送活跃用户
2. 如何标记活跃用户呢？活跃用户可以定义为最近几天内在微博中有过操作的用户，比如说刷新过信息流、发布过微博、转发评论点赞过微博，关注过其他用户等等，一旦有用户有过这些操作，我们就把他标记为活跃的用户

对大 V 来说，我们可以存储一个活跃粉丝的列表，这个列表里面就是我们标记的活跃用户。当某一个用户从不活跃用户变为活跃用户时，我们会查询这个用户的关注者中哪些是大 V，然后把这个用户写入到这些大 V 的活跃粉丝列表里面，这个活跃粉丝列表是定长的，如果活跃粉丝数量超过了长度，就把最先加入的粉丝从列表里剔除，这样可以保证推送的效率。

最后，一个用户被从活跃粉丝列表中剔除，或者是他从不活跃变成了活跃后，由于他不在大 V 用户的活跃粉丝列表中，所以也就不会收到微博的实时推送，他通过拉取的方式获得大V的微博