---
title: redis知识点汇总——线程模型
date: 2023-01-08T18:06:57+08:00
draft: false
categories: ["redis"]
tags: ["redis"]
---

# redis知识点汇总——线程模型
#技术/数据库/redis

Redis客户端对服务端的每次调用都经历了
- 发送命令
- 执行命令
- 返回结果
三个过程。其中执行命令阶段，由于Redis是单线程来处理命令的，所有到达服务端的命令都不会立刻执行，所有的命令都会进入一个队列中，然后逐个执行

## 实现
io多路复用模型：
- “多路”指的是多个网络连接
- “复用”指的是复用同一个Redis处理线程
redis的io多路复用是通过包装常见的select,poll,epoll,evpoll和kqueue这些多路复用函数库来实现的；
redis的io多路复用程序在#include宏定义了相应的规则，编译时选择系统中性能最高的io多路复用函数库来作为redis的io多路复用程序底层的实现：evport > epoll > kqueue > select

## 事件驱动
### 文件事件
redis服务端通过套接字与客户端进行连接，而文件事件就是服务端对套接字操作的抽象
1. io多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字
2. 尽管多个文件事件可能会并发地出现，但io多路复用程序总是会将所有产生事件的套接字都放到一个队列里面，然后通过这个队列，以有序、同步、每次一个套接字的方式像文件事件分派器传送该套接字
3. 当上一个套接字产生的事件被处理完之后，io多路复用程序才会继续向文件事件分派器传送下一个套接字
4. 文件事件分派器会根据事件类型调用相应的事件处理器
	1. 事件
		1. 当套接字变得可读时，套接字产生readable事件
		2. 当套接字变得可写时，套接字产生writable事件
		3. 如果一个套接字同时产生了这两种事件，那么事件分派器会优先处理readable事件，等到readable事件处理完后再处理writable事件。即一个套接字既可读又可写，redis先读套接字再写套接字
	2. 处理器
		1. 连接应答处理器：客户端发起连接，套接字会产生readable事件，引发连接应答操作
		2. 命令请求处理器：客户端向服务端发送命令请求时，套接字会产生readable事件，引发命令请求
		3. 命令回复处理器：redis有命令回复发送给客户端，就会产生writable事件，引发命令回复处理器的执行
## 时间事件
redis服务端中的一些操作需要在给定的时间点执行，时间事件就是redis服务端对这类定时操作的抽象

### 类型
- 定时事件
- 周期性事件

### 实现
redis将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器
新事件总是插入到链表的表头

### 举例
1. 更新服务器的各类统计信息：时间、内存占用、数据库占用
2. 清理数据库中过期的键值对
3. 关闭和清理连接失效的客户端
4. 尝试进行aof和rdb操作
5. 如果服务器是主服务器，对从服务器进行定期同步
6. 如果是集群模式，对集群进行定期同步和连接测试

## 总结
redis在一个大的for循环中，先处理文件事件，再处理时间事件，同步，有序，原子地执行。
时间事件在文件事件之后执行，所以时间事件的实际处理时间通常会比设定的到达时间晚一些。
